/**
 * E2E-UI Full Suite -- Rules Page (Real Server)
 *
 * NON-MOCKED SIMULATED-HUMAN REAL-BROWSER TESTS.
 * Tests the Rules page against a real Flapjack backend with seeded data.
 * Index `e2e-products` has 2 seeded rules:
 *   - rule-pin-macbook: Pin MacBook Pro to top when searching "laptop"
 *   - rule-hide-galaxy-tab: Hide Galaxy Tab S9 when searching "tablet"
 *
 * Covers:
 * - Listing: seeded rules visible, descriptions, count badge, pin/hide badges
 * - CRUD via UI: create rule via JSON editor dialog, delete via confirm dialog
 * - CRUD via API+UI: create via API → verify in UI → delete via API → verify gone
 * - Enabled/disabled indicator
 * - Merchandising Studio link navigation
 * - Clear All rules
 * - Condition/consequence summary display
 */
import { test, expect } from '../../fixtures/auth.fixture';
import { API_BASE, API_HEADERS, TEST_INDEX } from '../helpers';

const RULES_URL = `/index/${TEST_INDEX}/rules`;

test.describe('Rules', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto(RULES_URL);
    await expect(page.getByText('Rules').first()).toBeVisible({ timeout: 15_000 });
  });

  // ---------- Listing ----------

  test('list shows seeded rules', async ({ page }) => {
    const list = page.getByTestId('rules-list');
    await expect(list).toBeVisible({ timeout: 10_000 });

    await expect(page.getByText('rule-pin-macbook').first()).toBeVisible();
    await expect(page.getByText('rule-hide-galaxy-tab').first()).toBeVisible();
  });

  test('rule descriptions are visible', async ({ page }) => {
    const list = page.getByTestId('rules-list');
    await expect(list).toBeVisible({ timeout: 10_000 });

    await expect(page.getByText('Pin MacBook Pro to top when searching laptop').first()).toBeVisible();
    await expect(page.getByText('Hide Galaxy Tab S9 when searching tablet').first()).toBeVisible();
  });

  test('rule count badge shows correct number', async ({ page }) => {
    const countBadge = page.getByTestId('rules-count-badge');
    await expect(countBadge).toBeVisible({ timeout: 10_000 });
    const text = await countBadge.textContent();
    expect(Number(text)).toBeGreaterThanOrEqual(2);
  });

  test('rule cards show pinned/hidden badges', async ({ page }) => {
    const list = page.getByTestId('rules-list');
    await expect(list).toBeVisible({ timeout: 10_000 });

    await expect(list.getByText('1 pinned').first()).toBeVisible();
    await expect(list.getByText('1 hidden').first()).toBeVisible();
  });

  // ---------- CRUD via API + UI verification ----------

  test('create and delete a test rule via API and verify in UI', async ({ page, request }) => {
    const testRule = {
      objectID: 'e2e-test-rule',
      conditions: [{ pattern: 'e2e-test-query', anchoring: 'is' }],
      consequence: { promote: [{ objectID: 'p01', position: 0 }] },
      description: 'E2E test rule - should be cleaned up',
      enabled: true,
    };

    const res = await request.put(
      `${API_BASE}/1/indexes/${TEST_INDEX}/rules/${testRule.objectID}`,
      { headers: API_HEADERS, data: testRule }
    );
    expect(res.ok(), 'Failed to create test rule via API').toBeTruthy();

    await page.reload();
    await expect(page.getByText('Rules').first()).toBeVisible({ timeout: 15_000 });

    await expect(page.getByText('e2e-test-rule').first()).toBeVisible({ timeout: 10_000 });
    await expect(page.getByText('E2E test rule').first()).toBeVisible();

    // Cleanup
    await request.delete(
      `${API_BASE}/1/indexes/${TEST_INDEX}/rules/e2e-test-rule`,
      { headers: API_HEADERS }
    );

    await page.reload();
    await expect(page.getByText('Rules').first()).toBeVisible({ timeout: 15_000 });
    await expect(page.getByText('e2e-test-rule')).not.toBeVisible({ timeout: 10_000 });
  });

  // ---------- Create rule via UI dialog ----------

  test('create a rule via the Add Rule JSON editor dialog', async ({ page, request }) => {
    const addBtn = page.getByRole('button', { name: /add rule/i });
    await expect(addBtn).toBeVisible({ timeout: 10_000 });
    await addBtn.click();

    // Dialog should open with a Monaco JSON editor
    const dialog = page.getByRole('dialog');
    await expect(dialog).toBeVisible({ timeout: 10_000 });

    // Wait for the Monaco editor to load
    const editorOrFallback = dialog.locator('.monaco-editor').or(
      dialog.getByText('Loading editor...')
    );
    await expect(editorOrFallback).toBeVisible({ timeout: 15_000 });

    // Wait specifically for Monaco to be ready
    const monacoEditor = dialog.locator('.monaco-editor');
    await expect(monacoEditor).toBeVisible({ timeout: 15_000 });

    // Type valid rule JSON into the Monaco editor
    // Focus the editor and use keyboard to select all + replace
    await monacoEditor.click();
    const isMac = process.platform === 'darwin';
    const selectAllKey = isMac ? 'Meta+a' : 'Control+a';
    await monacoEditor.press(selectAllKey);

    const ruleJson = JSON.stringify({
      objectID: 'e2e-ui-created-rule',
      conditions: [{ pattern: 'e2e-ui-test', anchoring: 'is' }],
      consequence: { promote: [{ objectID: 'p02', position: 0 }] },
      description: 'Rule created via UI dialog test',
      enabled: true,
    }, null, 2);
    await monacoEditor.pressSequentially(ruleJson, { delay: 5 });

    // Click the Create/Save button
    const createBtn = dialog.getByRole('button', { name: /create|save/i });
    await expect(createBtn).toBeVisible();
    await createBtn.click();

    // Dialog should close
    await expect(dialog).not.toBeVisible({ timeout: 10_000 });

    // The new rule should appear in the list
    await expect(page.getByText('e2e-ui-created-rule').first()).toBeVisible({ timeout: 10_000 });

    // Cleanup via API
    await request.delete(
      `${API_BASE}/1/indexes/${TEST_INDEX}/rules/e2e-ui-created-rule`,
      { headers: API_HEADERS }
    );
  });

  // ---------- Delete rule via UI confirm dialog ----------

  test('delete a rule via the UI delete button and confirm dialog', async ({ page, request }) => {
    // Create a throwaway rule via API
    const testRule = {
      objectID: 'e2e-delete-rule-ui',
      conditions: [{ pattern: 'delete-me', anchoring: 'is' }],
      consequence: { promote: [{ objectID: 'p01', position: 0 }] },
      description: 'Delete me via UI',
      enabled: true,
    };
    await request.put(
      `${API_BASE}/1/indexes/${TEST_INDEX}/rules/${testRule.objectID}`,
      { headers: API_HEADERS, data: testRule }
    );

    await page.reload();
    await expect(page.getByText('Rules').first()).toBeVisible({ timeout: 15_000 });
    await expect(page.getByText('e2e-delete-rule-ui').first()).toBeVisible({ timeout: 10_000 });

    // Accept the upcoming confirm dialog
    page.on('dialog', (d) => d.accept());

    // Find the card and click delete
    const ruleCard = page.getByTestId('rules-list').locator('div', { hasText: 'e2e-delete-rule-ui' }).first();
    await ruleCard.getByRole('button', { name: /delete/i }).click();

    // Rule should disappear
    await expect(page.getByText('e2e-delete-rule-ui')).not.toBeVisible({ timeout: 10_000 });
  });

  // ---------- Enabled/Disabled Indicator ----------

  test('enabled rules show green power icon', async ({ page }) => {
    const list = page.getByTestId('rules-list');
    await expect(list).toBeVisible({ timeout: 10_000 });

    const greenIcons = list.locator('.text-green-500');
    await expect(greenIcons.first()).toBeVisible();
  });

  // ---------- Add Rule Button ----------

  test('Add Rule button is visible', async ({ page }) => {
    const addBtn = page.getByRole('button', { name: /add rule/i });
    await expect(addBtn).toBeVisible({ timeout: 10_000 });
  });

  // ---------- Merchandising Studio Link ----------

  test('Merchandising Studio link navigates to merchandising page', async ({ page }) => {
    // Link always exists — use the <a> link specifically (not the button variant)
    const merchLink = page.getByRole('link', { name: /merchandising studio/i });
    await expect(merchLink.first()).toBeVisible({ timeout: 10_000 });
    await merchLink.first().click();
    await expect(page).toHaveURL(new RegExp(`/index/${TEST_INDEX}/merchandising`));
  });

  // ---------- Rule condition/consequence summary ----------

  test('rule cards show condition pattern in summary', async ({ page }) => {
    const list = page.getByTestId('rules-list');
    await expect(list).toBeVisible({ timeout: 10_000 });

    await expect(page.getByText(/laptop/).first()).toBeVisible();
    await expect(page.getByText(/tablet/).first()).toBeVisible();
  });

  // ---------- Clear All Rules ----------

  test('Clear All button shows confirmation and can be cancelled', async ({ page }) => {
    const clearAllBtn = page.getByRole('button', { name: /clear all/i });

    if (await clearAllBtn.isVisible({ timeout: 5_000 }).catch(() => false)) {
      // Set up dialog handler to DISMISS (cancel) to avoid deleting seeded rules
      page.on('dialog', (d) => d.dismiss());

      await clearAllBtn.click();

      // If it uses a native confirm, we already dismissed it
      // If it uses a custom dialog, cancel it
      const dialog = page.getByRole('dialog');
      if (await dialog.isVisible({ timeout: 2_000 }).catch(() => false)) {
        const cancelBtn = dialog.getByRole('button', { name: /cancel/i });
        await cancelBtn.click();
        await expect(dialog).not.toBeVisible({ timeout: 5_000 });
      }

      // Seeded rules should still be visible (we cancelled)
      await expect(page.getByText('rule-pin-macbook').first()).toBeVisible();
    }
  });
});
