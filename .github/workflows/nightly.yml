name: Nightly Tests

# Comprehensive test suite that runs every night on the public repo
# This runs ALL tests with ALL configurations including:
# - All Rust tests (not just fast subset)
# - Dashboard integration tests with Algolia
# - All SDK tests across all supported versions
# - All integration tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

env:
  CARGO_TERM_COLOR: always

jobs:
  # Check if we're in the public repo - skip all tests if not
  check-repo:
    runs-on: ubuntu-latest
    outputs:
      is-public-repo: ${{ steps.check.outputs.is-public-repo }}
    steps:
      - id: check
        run: |
          if [ "${{ github.repository }}" = "gridlhq/flapjack" ]; then
            echo "is-public-repo=true" >> $GITHUB_OUTPUT
          else
            echo "is-public-repo=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # RUST ENGINE TESTS (ALL)
  # ============================================================================

  rust-all-tests:
    name: Rust all tests
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: engine
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h
        working-directory: .
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: engine
      - uses: taiki-e/install-action@nextest
      - name: Rustfmt
        run: cargo fmt --all --check
      - name: Clippy
        run: >
          cargo clippy --workspace --all-targets -- -D warnings
          -A clippy::too_many_arguments
          -A clippy::type_complexity
          -A clippy::only_used_in_recursion
          -A deprecated
      - name: Build binaries
        run: cargo build --package flapjack-server
      - name: Run all tests
        run: cargo nextest run -P ci

  installer-all:
    name: Installer tests (all platforms)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Run installer tests
        run: sh engine/tests/test_install.sh

  # ============================================================================
  # DASHBOARD TESTS (ALL)
  # ============================================================================

  dashboard-all:
    name: Dashboard all tests
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: engine/dashboard/package-lock.json
      - name: Install Playwright browsers
        working-directory: engine/dashboard
        run: npx playwright install --with-deps chromium
      - name: Install dependencies
        working-directory: engine/dashboard
        run: npm ci
      - name: Type check & build
        working-directory: engine/dashboard
        run: npm run build
      - name: Run unit tests
        working-directory: engine/dashboard
        run: npm run test:unit:run
      - name: Run page tests
        working-directory: engine/dashboard
        run: npm run test:pages
      - name: Run integration tests
        working-directory: engine/dashboard
        run: npm run test:integration
        env:
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_ADMIN_KEY: ${{ secrets.ALGOLIA_ADMIN_KEY }}
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dashboard-all-tests-report
          path: engine/dashboard/playwright-report/
          retention-days: 14

  # ============================================================================
  # SDK TESTS (ALL VERSIONS)
  # ============================================================================

  sdk-php-all:
    name: PHP SDK (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, curl, json
      - name: Install dependencies
        working-directory: sdks/php
        run: composer install --no-interaction --prefer-dist
      - name: Run tests
        working-directory: sdks/php
        run: vendor/bin/phpunit

  sdk-python-all:
    name: Python SDK (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ['3.9', '3.10', '3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Install Poetry
        run: pipx install poetry
      - name: Install dependencies
        working-directory: sdks/python
        run: poetry install
      - name: Run tests
        working-directory: sdks/python
        run: poetry run pytest

  sdk-javascript-all:
    name: JavaScript SDK (all Node versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ['18', '20', '22']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - name: Install dependencies
        working-directory: sdks/javascript/packages/flapjack-search
        run: npm install
      - name: Run tests
        working-directory: sdks/javascript/packages/flapjack-search
        run: npm test

  sdk-go-all:
    name: Go SDK (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go: ['1.21', '1.22', '1.23']
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
      - name: Run tests
        working-directory: sdks/go
        run: go test ./...

  sdk-ruby-all:
    name: Ruby SDK (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby: ['3.1', '3.2', '3.3']
    steps:
      - uses: actions/checkout@v4
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
          working-directory: sdks/ruby
      - name: Run tests
        working-directory: sdks/ruby
        run: bundle exec rake test

  sdk-java-all:
    name: Java SDK (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: ['17', '21']
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
      - name: Run tests
        working-directory: sdks/java
        run: ./gradlew test

  sdk-csharp-all:
    name: C# SDK (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dotnet: ['7.0.x', '8.0.x']
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet }}
      - name: Restore dependencies
        working-directory: sdks/csharp
        run: dotnet restore
      - name: Run tests
        working-directory: sdks/csharp
        run: dotnet test

  # ============================================================================
  # INTEGRATION TESTS (ALL VERSIONS)
  # ============================================================================

  integration-laravel-all:
    name: Laravel Scout (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, curl, json
      - name: Install dependencies
        working-directory: integrations/laravel-scout
        run: composer install --no-interaction --prefer-dist
      - name: Run tests
        working-directory: integrations/laravel-scout
        run: vendor/bin/phpunit

  integration-wordpress-all:
    name: WordPress (all versions)
    needs: check-repo
    if: needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
      - name: Checkout PHP SDK
        uses: actions/checkout@v4
        with:
          path: temp-php-sdk
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, curl, json
      - name: Copy PHP SDK
        run: |
          mkdir -p sdks/php
          cp -r temp-php-sdk/sdks/php/* sdks/php/ || true
      - name: Install dependencies
        working-directory: sdks/wordpress
        run: composer install --no-interaction --prefer-dist
      - name: Run unit tests
        working-directory: sdks/wordpress
        run: composer run test:unit
      - name: Run integration tests
        working-directory: sdks/wordpress
        run: composer run test:integration

  # ============================================================================
  # SUMMARY
  # ============================================================================

  nightly-summary:
    name: Nightly test summary
    needs:
      - check-repo
      - rust-all-tests
      - installer-all
      - dashboard-all
      - sdk-php-all
      - sdk-python-all
      - sdk-javascript-all
      - sdk-go-all
      - sdk-ruby-all
      - sdk-java-all
      - sdk-csharp-all
      - integration-laravel-all
      - integration-wordpress-all
    if: always() && needs.check-repo.outputs.is-public-repo == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "## Nightly Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Rust tests: ${{ needs.rust-all-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Installer tests: ${{ needs.installer-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard tests: ${{ needs.dashboard-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PHP SDK: ${{ needs.sdk-php-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python SDK: ${{ needs.sdk-python-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript SDK: ${{ needs.sdk-javascript-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Go SDK: ${{ needs.sdk-go-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ruby SDK: ${{ needs.sdk-ruby-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Java SDK: ${{ needs.sdk-java-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- C# SDK: ${{ needs.sdk-csharp-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Laravel Scout: ${{ needs.integration-laravel-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- WordPress: ${{ needs.integration-wordpress-all.result }}" >> $GITHUB_STEP_SUMMARY
